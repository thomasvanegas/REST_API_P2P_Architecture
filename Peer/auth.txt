import logging
import requests
import time
import json
import multiprocessing as mp
from datetime import datetime

API_URL = "http://localhost:8000/login"
SEARCH_URL = "http://localhost:8000/buscar"


class PeerAuth:
    # --- ConfiguraciÃ³n de logging ---
    logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s"
    )

    def peer_sender(username: str, files_index: list, interval: float = 30.0, timeout: float = 10.0):
        """
        Proceso que envÃ­a autenticaciones periÃ³dicas al API junto con el Ã­ndice de archivos.
        """
        loop = 0
        while True:
            loop += 1
            ts = datetime.now().isoformat(timespec="seconds")

            try:
                params = {
                    "username": username,
                    "password": "sd1234",
                    "files_index": json.dumps(files_index)
                }

                resp = requests.post(API_URL, params=params, timeout=timeout)
                logging.info(f"{username} intento #{loop}: ENVIADO (status={resp.status_code})")

            except requests.exceptions.RequestException as e:
                logging.error(f"{username} intento #{loop}: ERROR autenticando -> {e}")

            time.sleep(interval)


    def buscar_archivo(filename: str):
        """
        FunciÃ³n que hace la bÃºsqueda de un archivo en la API.
        """
        try:
            resp = requests.get(SEARCH_URL, params={"filename": filename}, timeout=10)
            if resp.status_code == 200:
                logging.info(f"âœ… Archivo encontrado: {resp.json()}")
            else:
                logging.warning(f"âš ï¸ {resp.json()}")
        except requests.exceptions.RequestException as e:
            logging.error(f"âŒ Error al buscar archivo: {e}")


    def peer_menu():
        """
        MenÃº en consola interactivo. Solo funciona si entras al contenedor con -it.
        """
        while True:
            print("\n=== MENÃš PEER ===")
            print("1. Buscar archivo")
            print("2. Salir")
            opcion = input("ðŸ‘‰ Selecciona una opciÃ³n: ")

            if opcion == "1":
                filename = input("ðŸ‘‰ Nombre del archivo a buscar: ")
                PeerAuth.buscar_archivo(filename)
            elif opcion == "2":
                print("ðŸ‘‹ Cerrando menÃº...")
                break
            else:
                print("âŒ OpciÃ³n invÃ¡lida.")




'''
import requests
import time
import multiprocessing as mp
from datetime import datetime

class PeerAuth:
    import requests
import time
import multiprocessing as mp
from datetime import datetime
import json

class PeerAuth:

    API_URL = "http://localhost:8000/login"

    @staticmethod
    def peer_sender(name: str, username: str, files_index: list, interval: float,
                    initial_delay: float = 0.0, timeout: float = 10.0):
        """
        FunciÃ³n que ejecuta cada proceso 'peer'.
        - name: nombre del proceso (ej. "Peer1")
        - username: credencial de usuario a usar
        - files_index: lista de archivos del peer [{"namefile":"...","url":"..."}, ...]
        - interval: segundos entre envÃ­os
        - initial_delay: retardo antes del primer envÃ­o
        - timeout: timeout para requests
        """

        if initial_delay > 0:
            time.sleep(initial_delay)

        loop = 0
        while True:
            loop += 1
            ts = datetime.now().isoformat(timespec='seconds')

            # Si es Peer3, despuÃ©s de 2 envÃ­os, pausa 3 minutos y luego sigue normalmente
            if name == "Peer3" and loop == 2:
                print(f"[{ts}] {name} - Pausando autenticaciÃ³n por 3 minutos...")
                time.sleep(180)  # 3 minutos
                print(f"[{datetime.now().isoformat(timespec='seconds')}] {name} - Reanudando autenticaciÃ³n.")

            try:
                # Construir parÃ¡metros (query params) con credenciales + files_index
                params = {
                    "username": username,
                    "password": "sd1234",
                    "files_index": json.dumps(files_index)  # mandamos la lista como string JSON
                }

                resp = requests.post(PeerAuth.API_URL, params=params, timeout=timeout)

                sent_msg = f"[{ts}] {name} - intento #{loop}: mensaje ENVIADO (status={resp.status_code})"
                try:
                    content = resp.json()
                except ValueError:
                    content = resp.text

                print(sent_msg)
                print(f"    enviado files_index: {params['files_index']}")
                print(f"    respuesta: {content}")

            except requests.exceptions.RequestException as e:
                err_ts = datetime.now().isoformat(timespec='seconds')
                print(f"[{err_ts}] {name} - intento #{loop}: ERROR al enviar -> {e}")

            time.sleep(interval)
'''


''' import os
    import time
    import requests

    API_URL = os.environ["API_URL"]

    peer_data = {
        "username": os.environ["PEER_NAME"],
        "password": os.environ["PEER_PASSWORD"],
        "url": os.environ["PEER_URL"],
    }

    while True:
        try:
            response = requests.post(
                API_URL,
                params={
                    "username": peer_data["username"],
                    "password": peer_data["password"]
                }
            )
            print(f"[{peer_data['username']}] Respuesta del servidor:", response.json())
        except Exception as e:
            print(f"[{peer_data['username']}] Error conectando a la API:", e)

        time.sleep(60)
 '''